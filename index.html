<!doctype html>
<html lang="lb">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Kart-Challenge</title>
  <style>
    :root { --bg:#0f1220; --card:#1b2140; --text:#f3f5ff; --muted:#b8c0ff; }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{background:radial-gradient(1200px 600px at 50% -10%, #2a3775 0%, var(--bg) 55%, #090b14 100%); color:var(--text);}
    .wrap{max-width:980px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:12px;}
    .top{display:flex;gap:12px;align-items:stretch;flex-wrap:wrap;}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px; backdrop-filter: blur(6px);}
    .driver{display:flex;gap:12px;align-items:center;min-width:280px;flex:1;}
    .avatar{width:92px;height:92px;border-radius:16px;overflow:hidden;background:#0b0e1a;border:1px solid rgba(255,255,255,.12);flex:0 0 auto;}
    .avatar img{width:100%;height:100%;object-fit:cover;}
    .driver h1{font-size:18px;margin:0 0 4px 0;}
    .driver p{margin:0;color:var(--muted);font-size:13px;line-height:1.25;}
    .stats{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:999px;
      background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.10); font-size:14px;}
    .pill b{font-variant-numeric:tabular-nums;}
    .gamecard{flex:1;min-width:280px;}
    canvas{width:100%;height:auto;border-radius:16px;background:linear-gradient(180deg,#121736,#0b0e1a);
      border:1px solid rgba(255,255,255,.10); touch-action:none;}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    button{background:#3b5bff;color:white;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    button.secondary{background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.12)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .hint{color:var(--muted);font-size:12px;margin:6px 0 0}
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:16px;background:rgba(0,0,0,.65)}
    .modal{max-width:520px;width:100%;border-radius:18px;padding:16px;background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.12)}
    .modal h2{margin:0 0 8px}
    .modal p{margin:0 0 12px;color:var(--muted)}
    .bigScore{font-size:38px;margin:10px 0 0;font-weight:900}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    .small{font-size:12px;color:var(--muted)}
    input[type="text"]{background:rgba(255,255,255,.08);color:var(--text);outline:none}
    input::placeholder{color:rgba(255,255,255,.55)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="card driver">
        <div class="avatar"><img id="avatarImg" alt="Avatar" src="gilles.png"></div>
        <div>
          <h1 id="driverName">Gilles</h1>
          <p id="driverLine">Bereet? Sammel ‚≠ê (+5) a weich üçå aus (-5). Z√§it: <b>45s</b>.</p>
          <div class="stats">
            <span class="pill">‚≠ê St√§r: <b>+5</b></span>
            <span class="pill">üçå Banana: <b>-5</b></span>
            <span class="pill">Score: <b id="scoreTxt">0</b></span>
            <span class="pill">Z√§it: <b id="timeTxt">45</b>s</span>
          </div>
          <div class="hint" id="controlHint">Desktop: Pfeiltasten ‚Ä¢ Mobile: Tippen/halen l√©nks/riets</div>
        </div>
      </div>

      <div class="card gamecard">
        <div class="controls">
          <div class="small">Kart-Challenge (LU)</div>
          <div class="row">
            <button id="startBtn">Start</button>
            <button id="restartBtn" class="secondary">Neistarten</button>
          </div>
        </div>
        <div class="hint">Zil: Sammel esou vill ‚≠ê w√©i m√©iglech an tr√´ff keng üçå.</div>
        <canvas id="c" width="900" height="520" aria-label="Kart game canvas"></canvas>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <h2 id="endTitle">F√§erdeg!</h2>
      <p id="endText">G√´ff elo de Geheimcode an. N√´mmen da geet d‚ÄôIwwerraschung op‚Ä¶ üéÅ</p>

      <div class="bigScore">Score: <span id="finalScore">0</span></div>

      <div style="margin-top:14px">
        <label for="codeInput" class="small">Geheimcode:</label>
        <input id="codeInput"
               type="text"
               inputmode="numeric"
               autocomplete="one-time-code"
               maxlength="6"
               placeholder="z.B. 4817"
               style="width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);margin-top:6px;font-size:18px;text-align:center" />
        <div id="codeFeedback" class="small" style="margin-top:6px;color:#ffb3b3"></div>

        <button id="revealBtn"
                style="margin-top:12px;display:none;width:100%"
                type="button">
          üèÅ Wou geet et hin?
        </button>
      </div>

      <div class="hint" style="margin-top:10px">Tip: Wann et net klappt, kontroll√©ier d‚ÄôZifferen nach eng K√©ier.</div>

      <div class="row" style="margin-top:12px">
        <button id="playAgain" type="button">Nach eng K√©ier</button>
        <button id="closeModal" class="secondary" type="button">Zoumaachen</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // ======= CONFIG =======
  const SECRET_CODE = "4817"; // <-- HEEI den richtege Code asetzen (4 oder 6 Zifferen)

  const config = {
    durationSec: 45,
    scoreStar: +5,
    scoreBanana: -5,
    spawnRate: 0.65,      // base spawn per second
    maxObjects: 18,
    speedMin: 180,
    speedMax: 320,
  };

  // --- Player selection via URL: ?player=gilles or ?player=mara
  const params = new URLSearchParams(location.search);
  const player = (params.get("player") || "gilles").toLowerCase();

  const avatarImg = document.getElementById("avatarImg");
  const driverName = document.getElementById("driverName");

  if (player === "mara") {
    avatarImg.src = "mara.png";
    driverName.textContent = "Mara";
  } else {
    avatarImg.src = "gilles.png";
    driverName.textContent = "Gilles";
  }

  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");

  const scoreTxt = document.getElementById("scoreTxt");
  const timeTxt  = document.getElementById("timeTxt");

  const startBtn = document.getElementById("startBtn");
  const restartBtn = document.getElementById("restartBtn");

  const overlay = document.getElementById("overlay");
  const finalScoreEl = document.getElementById("finalScore");
  const playAgainBtn = document.getElementById("playAgain");
  const closeModalBtn = document.getElementById("closeModal");

  // Code UI
  const codeInput = document.getElementById("codeInput");
  const codeFeedback = document.getElementById("codeFeedback");
  const revealBtn = document.getElementById("revealBtn");

  // World
  const W = canvas.width, H = canvas.height;

  // Player (kart)
  const kart = {
    x: W * 0.5,
    y: H - 70,
    w: 86,
    h: 42,
    vx: 0,
    speed: 520
  };

  // Objects
  // type: "star" or "banana"
  let objs = [];

  // Game state
  let running = false;
  let lastT = 0;
  let score = 0;
  let timeLeft = config.durationSec;
  let spawnAcc = 0;

  // Input
  const keys = { left:false, right:false };
  let touchDir = 0; // -1 left, +1 right

  function reset() {
    running = false;
    lastT = 0;
    score = 0;
    timeLeft = config.durationSec;
    objs = [];
    spawnAcc = 0;
    kart.x = W * 0.5;
    kart.vx = 0;
    scoreTxt.textContent = score;
    timeTxt.textContent = timeLeft;

    // reset modal/code state
    overlay.style.display = "none";
    codeInput.value = "";
    codeFeedback.textContent = "";
    revealBtn.style.display = "none";

    draw(0);
  }

  function start() {
    if (running) return;
    running = true;
    lastT = performance.now();
    requestAnimationFrame(loop);
  }

  function end() {
    running = false;
    finalScoreEl.textContent = score;

    // open modal
    overlay.style.display = "flex";
    // focus input for easy typing
    setTimeout(() => codeInput.focus(), 50);
  }

  function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }
  function rand(a,b){ return a + Math.random()*(b-a); }

  function spawn(dt) {
    spawnAcc += dt * config.spawnRate;
    while (spawnAcc >= 1 && objs.length < config.maxObjects) {
      spawnAcc -= 1;

      // slightly more stars than bananas
      const type = Math.random() < 0.58 ? "star" : "banana";
      const size = type === "star" ? 30 : 34;

      objs.push({
        type,
        x: rand(40, W-40),
        y: -40,
        r: size/2,
        vy: rand(config.speedMin, config.speedMax)
      });
    }
  }

  function collideCircleRect(cx, cy, r, rx, ry, rw, rh) {
    const nx = clamp(cx, rx, rx+rw);
    const ny = clamp(cy, ry, ry+rh);
    const dx = cx - nx, dy = cy - ny;
    return (dx*dx + dy*dy) <= (r*r);
  }

  function update(dt) {
    timeLeft -= dt;
    if (timeLeft <= 0) {
      timeLeft = 0;
      timeTxt.textContent = "0";
      end();
      return;
    }
    timeTxt.textContent = Math.ceil(timeLeft).toString();

    // input -> velocity
    let dir = 0;
    if (keys.left) dir -= 1;
    if (keys.right) dir += 1;
    dir += touchDir;
    dir = clamp(dir, -1, 1);

    kart.vx = dir * kart.speed;
    kart.x += kart.vx * dt;
    kart.x = clamp(kart.x, 20 + kart.w/2, W - 20 - kart.w/2);

    // spawn objects
    spawn(dt);

    // move objects + collisions
    for (let i = objs.length - 1; i >= 0; i--) {
      const o = objs[i];
      o.y += o.vy * dt;

      const rx = kart.x - kart.w/2;
      const ry = kart.y - kart.h/2;

      if (collideCircleRect(o.x, o.y, o.r, rx, ry, kart.w, kart.h)) {
        if (o.type === "star") score += config.scoreStar;
        else score += config.scoreBanana;

        scoreTxt.textContent = score;
        objs.splice(i, 1);
        continue;
      }

      if (o.y > H + 60) objs.splice(i, 1);
    }
  }

  function roundRect(x,y,w,h,r,fill,stroke){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
    if (fill) ctx.fill();
    if (stroke) ctx.stroke();
  }

  function drawKart() {
    const x = kart.x, y = kart.y;
    ctx.save();
    ctx.translate(x, y);

    // shadow
    ctx.globalAlpha = 0.25;
    ctx.beginPath();
    ctx.ellipse(0, 18, 50, 14, 0, 0, Math.PI*2);
    ctx.fillStyle = "#000";
    ctx.fill();
    ctx.globalAlpha = 1;

    // body
    ctx.fillStyle = "rgba(255,255,255,0.10)";
    ctx.strokeStyle = "rgba(255,255,255,0.20)";
    roundRect(-kart.w/2, -kart.h/2, kart.w, kart.h, 10, true, true);

    // cockpit
    ctx.fillStyle = "rgba(0,0,0,0.25)";
    roundRect(-20, -16, 40, 22, 10, true, false);

    // wheels
    ctx.fillStyle = "rgba(0,0,0,0.5)";
    roundRect(-kart.w/2 - 6, -kart.h/2 + 6, 14, 18, 6, true, false);
    roundRect(kart.w/2 - 8, -kart.h/2 + 6, 14, 18, 6, true, false);

    // driver emoji
    ctx.font = "28px system-ui, Apple Color Emoji, Segoe UI Emoji";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("üèéÔ∏è", 0, -2);

    ctx.restore();
  }

  function drawObj(o) {
    ctx.save();
    ctx.translate(o.x, o.y);
    ctx.font = o.type === "star"
      ? "30px system-ui, Apple Color Emoji, Segoe UI Emoji"
      : "34px system-ui, Apple Color Emoji, Segoe UI Emoji";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(o.type === "star" ? "‚≠ê" : "üçå", 0, 0);
    ctx.restore();
  }

  function draw() {
    ctx.clearRect(0,0,W,H);

    // lanes
    ctx.save();
    ctx.globalAlpha = 0.22;
    ctx.fillStyle = "#ffffff";
    for (let i=1;i<6;i++){
      const lx = (W/6)*i;
      ctx.fillRect(lx-2, 0, 4, H);
    }
    ctx.restore();

    // mini legend
    ctx.save();
    ctx.globalAlpha = 0.9;
    ctx.fillStyle = "rgba(255,255,255,0.10)";
    roundRect(16, 16, 260, 44, 14, true, false);
    ctx.fillStyle = "rgba(255,255,255,0.92)";
    ctx.font = "700 16px system-ui";
    ctx.textBaseline = "middle";
    ctx.fillText("‚≠ê +5   üçå -5", 26, 38);
    ctx.restore();

    for (const o of objs) drawObj(o);
    drawKart();

    if (!running) {
      ctx.save();
      ctx.globalAlpha = 0.7;
      ctx.fillStyle = "rgba(0,0,0,0.55)";
      ctx.fillRect(0,0,W,H);
      ctx.globalAlpha = 1;
      ctx.fillStyle = "rgba(255,255,255,0.95)";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.font = "800 30px system-ui";
      ctx.fillText("Dr√©ck op START", W/2, H/2 - 20);
      ctx.font = "500 14px system-ui";
      ctx.fillText("Sammel ‚≠ê a weich üçå aus", W/2, H/2 + 18);
      ctx.restore();
    }
  }

  function loop(t) {
    if (!running) return;
    const dt = Math.min(0.033, (t - lastT)/1000);
    lastT = t;
    update(dt);
    draw();
    if (running) requestAnimationFrame(loop);
  }

  // ======= INPUT =======
  window.addEventListener("keydown", (e) => {
    if (e.key === "ArrowLeft") keys.left = true;
    if (e.key === "ArrowRight") keys.right = true;
    if (e.key === " " && !running) start();
  });
  window.addEventListener("keyup", (e) => {
    if (e.key === "ArrowLeft") keys.left = false;
    if (e.key === "ArrowRight") keys.right = false;
  });

  // Touch / mouse: left half = left, right half = right
  function setTouchDirFromEvent(ev) {
    const rect = canvas.getBoundingClientRect();
    const x = ("touches" in ev) ? ev.touches[0].clientX : ev.clientX;
    const cx = x - rect.left;
    touchDir = (cx < rect.width/2) ? -1 : +1;
  }
  function clearTouchDir(){ touchDir = 0; }

  canvas.addEventListener("pointerdown", (e)=>{ setTouchDirFromEvent(e); });
  canvas.addEventListener("pointermove", (e)=>{ if (e.buttons) setTouchDirFromEvent(e); });
  canvas.addEventListener("pointerup", clearTouchDir);
  canvas.addEventListener("pointercancel", clearTouchDir);

  // ======= BUTTONS =======
  startBtn.addEventListener("click", start);
  restartBtn.addEventListener("click", () => { reset(); start(); });

  playAgainBtn.addEventListener("click", () => { reset(); start(); });
  closeModalBtn.addEventListener("click", () => { overlay.style.display = "none"; });

  // ======= CODE CHECK =======
  function normalizeCode(s){ return (s || "").replace(/\s+/g,""); }

  codeInput.addEventListener("input", () => {
    const entered = normalizeCode(codeInput.value);
    const target  = normalizeCode(SECRET_CODE);

    if (!entered) {
      codeFeedback.textContent = "";
      revealBtn.style.display = "none";
      return;
    }

    if (entered === target) {
      codeFeedback.textContent = "‚úîÔ∏è Code richteg!";
      codeFeedback.style.color = "#9dff9d";
      revealBtn.style.display = "block";
    } else {
      codeFeedback.textContent = "‚ùå Code net richteg ‚Äì prob√©ier nach eng K√©ier";
      codeFeedback.style.color = "#ffb3b3";
      revealBtn.style.display = "none";
    }
  });

  // Open in SAME TAB
  revealBtn.addEventListener("click", () => {
    window.location.href = "https://www.battlekart.com/de/";
  });

  // Init
  reset();
})();
</script>
</body>
</html>

