<!doctype html>
<html lang="lb">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>X-mas 2025</title>

  <style>
    @font-face{
      font-family: "Mario256";
      src: url("https://github.com/albrechtclaire1007/GM1/raw/refs/heads/main/SuperMario256.ttf") format("truetype");
      font-display: swap;
    }

    :root{
      --bg:#ffffff;
      --text:#111;
      --muted:#555;
      --accent:#1e40ff;
      --danger:#ff2b2b;
      --ok:#16a34a;
      --laneBorder:#e6e6e6;
    }

    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    .mk{font-family:"Mario256", system-ui, sans-serif; letter-spacing: .5px;}
    .screen{min-height:100vh;display:none;}
    .screen.active{display:block;}
    .center{max-width:980px;margin:0 auto;padding:22px;}
    .title{font-size:44px; margin:0 0 10px 0;}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:14px 18px;border-radius:14px;border:0;background:var(--accent);
      color:#fff;font-weight:800;cursor:pointer;min-width:160px;
      box-shadow:0 6px 18px rgba(0,0,0,.12);
      text-decoration:none;
    }
    .btn.secondary{background:#111;}
    .btn:active{transform:translateY(1px);}
    .p{font-size:18px;line-height:1.35;color:var(--muted);margin:0 0 18px 0;max-width:820px;}

    /* Player select */
    .players{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:18px;
      align-items:stretch;
    }
    @media (max-width:780px){
      .players{grid-template-columns: 1fr; }
      .title{font-size:38px;}
    }
    .playerCard{
      border:2px solid #eee;border-radius:18px;padding:14px;
      display:flex;gap:14px;align-items:center;cursor:pointer;
      transition:.12s ease;
    }
    .playerCard:hover{border-color:#d2d9ff; background:#fafbff;}
    .playerCard img{
      width:160px;height:auto;max-height:160px;object-fit:contain;border-radius:14px;
      background:#f6f6f6;border:1px solid #eee;
    }
    .playerName{font-size:34px;margin:0;}

    /* Countdown */
    .countdownWrap{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(255,255,255,.92); z-index:50;
    }
    .countNum{
      font-family:"Mario256", system-ui, sans-serif;
      font-size:min(28vw,180px);
      color:#111;
      text-shadow:0 10px 0 rgba(0,0,0,.06);
    }

    /* Game full page */
    #gameScreen{padding:0; margin:0;}
    .topbar{
      position:fixed;left:0;right:0;top:0;height:56px;
      display:flex;align-items:center;justify-content:space-between;
      padding:0 14px;background:#fff;border-bottom:2px solid #eee; z-index:10;
    }
    .topbar .mk{font-size:22px;}
    .topbar .stat{display:flex;gap:14px;align-items:center;}
    .chip{font-family:"Mario256", system-ui, sans-serif; font-size:18px;}
    .gameArea{
      position:fixed;inset:56px 0 0 0;
      display:flex;align-items:stretch;justify-content:center;
      background:#fff;
    }
    canvas{
      width:100%;
      height:100%;
      display:block;
      touch-action:none;
      background:#fff;
    }

    /* Modal */
    .overlay{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.35); z-index:60; padding:18px;
    }
    .modal{
      width:min(720px, 96vw);
      background:#fff;border-radius:20px;padding:18px 18px 14px 18px;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
      border:2px solid #eee;
      text-align:center;
    }
    .modal h2{margin:0 0 10px;font-size:34px;}
    .modal .mk{font-size:34px;}
    .modal .btn{width:100%; margin-top:10px;}

    /* Chest screen */
    .chestWrap{max-width:980px;margin:0 auto;padding:22px;text-align:center;}
    .chestTitle{margin:0 0 10px 0;font-size:40px;}
    .chestMedia{
      width:min(740px, 96vw);
      margin:14px auto 10px;
      border-radius:18px;
      border:2px solid #eee;
      overflow:hidden;
      background:#f7f7f7;
    }
    .chestMedia img, .chestMedia video{width:100%;height:auto;display:block;}
    .codeRow{
      display:flex;gap:10px;justify-content:center;align-items:center;
      margin:14px 0 6px;
      flex-wrap:wrap;
    }
    .digit{
      width:64px;height:64px;border-radius:14px;border:2px solid #e6e6e6;
      text-align:center;font-size:28px;font-weight:900;
      outline:none;
      font-family:"Mario256", system-ui, sans-serif;
    }
    .help{color:var(--muted);font-size:14px;margin-top:8px;}
    .battlePopupImg{width:min(720px, 96vw);height:auto;border-radius:18px;border:2px solid #eee;display:block;}
    .battleActions{padding:12px 10px 4px;}
  </style>
</head>

<body>

  <!-- 1) Instructions -->
  <section id="instructionsScreen" class="screen active">
    <div class="center">
      <h1 class="title mk">X-mas 2025</h1>
      <p class="p">
        Fir √§re erauszefanne wat √§re Kaddo ass, musst der an 50 Sekonnen 50 Punkte sammelen.<br/>
        Sammel ‚≠êÔ∏è fir Punkten ze sammelen an evit√©ier üçå! Wann s du dat ronnbr√©ngs kriss du 2 Stelle vum Geheimcode.
        D√§r musst et allen 2 packen fir d√©i 4 Zifferen ze fannen.
      </p>
      <button id="goBtn" class="btn mk">A lass!</button>
    </div>
  </section>

  <!-- 2) Player Select -->
  <section id="playerScreen" class="screen">
    <div class="center">
      <h1 class="title mk">Wien spillt?</h1>

      <div class="players">
        <div class="playerCard" role="button" tabindex="0" data-player="gilles">
          <img src="gilles.png" alt="Gilles Avatar">
          <div>
            <p class="playerName mk">Gilles</p>
          </div>
        </div>

        <div class="playerCard" role="button" tabindex="0" data-player="mara">
          <img src="mara.png" alt="Mara Avatar">
          <div>
            <p class="playerName mk">Mara</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Countdown -->
  <div id="countdownWrap" class="countdownWrap" aria-hidden="true">
    <div id="countNum" class="countNum">3</div>
  </div>

  <!-- 3) Game -->
  <section id="gameScreen" class="screen">
    <div class="topbar">
      <div class="mk" id="topName">Gilles</div>
      <div class="stat">
        <div class="chip mk"><span id="topTimer">0:50</span></div>
        <div class="chip mk">Score: <span id="topScore">0</span></div>
      </div>
    </div>

    <div class="gameArea">
      <canvas id="gameCanvas" width="900" height="1600"></canvas>
    </div>
  </section>

  <!-- End Modal -->
  <div id="endOverlay" class="overlay" aria-hidden="true">
    <div class="modal">
      <h2 class="mk">Super!</h2>
      <div id="endText" class="mk">Deng 2 Ziffere sinn 17!</div>
      <button id="toChestBtn" class="btn mk">Weider bei d'Schatzk√´scht</button>
    </div>
  </div>

  <!-- 4) Chest -->
  <section id="chestScreen" class="screen">
    <div class="chestWrap">
      <h1 class="chestTitle mk">D'Schatzk√´scht</h1>

      <div class="chestMedia" id="chestMedia">
        <img id="chestImg" src="" alt="K√´scht">
        <video id="chestVid" src="" style="display:none" playsinline muted></video>
      </div>

      <div class="codeRow" aria-label="Code Input">
        <input class="digit" inputmode="numeric" maxlength="1" id="d1">
        <input class="digit" inputmode="numeric" maxlength="1" id="d2">
        <input class="digit" inputmode="numeric" maxlength="1" id="d3">
        <input class="digit" inputmode="numeric" maxlength="1" id="d4">
      </div>

      <div class="help">G√´ff d√©i 4 Zifferen an, fir d‚ÄôK√´scht opzemaachen.</div>
      <div class="help" id="chestFeedback" style="min-height:18px"></div>
    </div>
  </section>

  <!-- Battlekart popup -->
  <div id="battleOverlay" class="overlay" aria-hidden="true">
    <div class="modal" style="padding:10px">
      <img src="battlekart.png" alt="Battlekart" class="battlePopupImg">
      <div class="battleActions">
        <a class="btn mk" href="https://www.battlekart.com/en/trier/giftpdf/df7e3d33f95603213e338a17cdaf14e0">
          Bong eroflueden
        </a>
      </div>
    </div>
  </div>

<script>
(() => {
  /* ===== IMPORTANT: "k√´scht.png/mp4" on GitHub Pages can break due to the √´.
     We set the SRC using URL-encoded filenames: k%C3%ABscht.png / k%C3%ABscht.mp4
     (This fixes the ‚Äúk√´scht image not working‚Äù in most cases.)
  */
  const CHEST_PNG = "k%C3%ABscht.png";
  const CHEST_MP4 = "k%C3%ABscht.mp4";

  const GAME_SECONDS = 50;
  const TARGET_SCORE = 50;

  const PLAYER_DIGITS = { gilles: "17", mara: "48" };
  const CHEST_CODE = "1748";

  const screens = {
    instructions: document.getElementById("instructionsScreen"),
    player: document.getElementById("playerScreen"),
    game: document.getElementById("gameScreen"),
    chest: document.getElementById("chestScreen")
  };

  const goBtn = document.getElementById("goBtn");
  const countdownWrap = document.getElementById("countdownWrap");
  const countNum = document.getElementById("countNum");

  const topName = document.getElementById("topName");
  const topTimer = document.getElementById("topTimer");
  const topScore = document.getElementById("topScore");

  const endOverlay = document.getElementById("endOverlay");
  const endText = document.getElementById("endText");
  const toChestBtn = document.getElementById("toChestBtn");

  const battleOverlay = document.getElementById("battleOverlay");

  function showScreen(name){
    Object.values(screens).forEach(s => s.classList.remove("active"));
    screens[name].classList.add("active");
    window.scrollTo(0,0);
  }

  let currentPlayer = null;

  goBtn.addEventListener("click", () => showScreen("player"));

  document.querySelectorAll(".playerCard").forEach(card => {
    const pick = () => {
      currentPlayer = card.dataset.player;
      startCountdownThenGame();
    };
    card.addEventListener("click", pick);
    card.addEventListener("keydown", (e) => { if (e.key === "Enter" || e.key === " ") pick(); });
  });

  function startCountdownThenGame(){
    showScreen("game");
    topName.textContent = currentPlayer === "mara" ? "Mara" : "Gilles";
    countdownWrap.style.display = "flex";
    countdownWrap.setAttribute("aria-hidden","false");

    let n = 3;
    countNum.textContent = n;

    const tick = () => {
      n -= 1;
      if (n <= 0){
        countdownWrap.style.display = "none";
        countdownWrap.setAttribute("aria-hidden","true");
        gameStart();
        return;
      }
      countNum.textContent = n;
      setTimeout(tick, 800);
    };
    setTimeout(tick, 800);
  }

  /* ===================== GAME (3 lanes) ===================== */
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  function resizeCanvasToViewport(){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const w = window.innerWidth;
    const h = window.innerHeight - 56;
    canvas.style.width = w + "px";
    canvas.style.height = h + "px";
    canvas.width = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener("resize", () => {
    if (screens.game.classList.contains("active")) resizeCanvasToViewport();
  });

  const state = {
    running: false,
    timeLeft: GAME_SECONDS,
    score: 0,
    lane: 1,
    items: [],
    lastTs: 0,
    spawnAcc: 0,
    avatarImg: null
  };

  const laneCount = 3;

  function fmtTime(sec){
    const s = Math.max(0, Math.ceil(sec));
    return `0:${String(s).padStart(2,"0")}`;
  }

  function resetGame(){
    state.running = false;
    state.timeLeft = GAME_SECONDS;
    state.score = 0;
    state.lane = 1;
    state.items = [];
    state.lastTs = 0;
    state.spawnAcc = 0;
    topScore.textContent = "0";
    topTimer.textContent = fmtTime(GAME_SECONDS);
  }

  function loadAvatar(){
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = () => resolve(null);
      img.src = currentPlayer === "mara" ? "mara.png" : "gilles.png";
    });
  }

  function setLaneFromX(x){
    const w = canvas.clientWidth || window.innerWidth;
    const third = w / laneCount;
    state.lane = Math.max(0, Math.min(laneCount-1, Math.floor(x / third)));
  }

  canvas.addEventListener("pointerdown", (e) => {
    const rect = canvas.getBoundingClientRect();
    setLaneFromX(e.clientX - rect.left);
  });
  canvas.addEventListener("pointermove", (e) => {
    if (e.buttons){
      const rect = canvas.getBoundingClientRect();
      setLaneFromX(e.clientX - rect.left);
    }
  });

  window.addEventListener("keydown", (e) => {
    if (!state.running) return;
    if (e.key === "ArrowLeft") state.lane = Math.max(0, state.lane - 1);
    if (e.key === "ArrowRight") state.lane = Math.min(laneCount-1, state.lane + 1);
  });

  function rand(a,b){ return a + Math.random()*(b-a); }

  function spawn(dt){
    const spawnRate = 1.25;
    state.spawnAcc += dt * spawnRate;

    const h = canvas.clientHeight || (window.innerHeight - 56);

    while (state.spawnAcc >= 1){
      state.spawnAcc -= 1;

      const isStar = Math.random() < 0.62;
      const type = isStar ? "star" : "banana";
      const lane = Math.floor(Math.random() * laneCount);

      state.items.push({
        type,
        lane,
        y: -40,
        speed: isStar ? rand(360, 520) : rand(380, 560),
        size: isStar ? 34 : 38
      });

      if (state.items.length > 40) state.items.shift();
    }
  }

  function update(dt){
    state.timeLeft -= dt;
    if (state.timeLeft <= 0){
      state.timeLeft = 0;
      topTimer.textContent = fmtTime(0);
      finishGame();
      return;
    }
    topTimer.textContent = fmtTime(state.timeLeft);

    spawn(dt);

    const w = canvas.clientWidth || window.innerWidth;
    const h = canvas.clientHeight || (window.innerHeight - 56);

    const playerY = h - 110;
    const hitYMin = playerY - 20;
    const hitYMax = playerY + 60;

    for (let i = state.items.length - 1; i >= 0; i--){
      const it = state.items[i];
      it.y += it.speed * dt;

      if (it.lane === state.lane && it.y >= hitYMin && it.y <= hitYMax){
        state.score += (it.type === "star") ? 5 : -5;
        topScore.textContent = String(state.score);
        state.items.splice(i,1);

        if (state.score >= TARGET_SCORE){
          finishGame();
          return;
        }
      } else if (it.y > h + 60){
        state.items.splice(i,1);
      }
    }
  }

  function roundRect(ctx, x, y, w, h, r, fill, stroke){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
    if (fill) ctx.fill();
    if (stroke) ctx.stroke();
  }

  function draw(){
    const w = canvas.clientWidth || window.innerWidth;
    const h = canvas.clientHeight || (window.innerHeight - 56);

    ctx.clearRect(0,0,w,h);

    ctx.save();
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--laneBorder').trim() || "#e6e6e6";
    ctx.lineWidth = 2;
    for (let i=1;i<laneCount;i++){
      const x = (w/laneCount)*i;
      ctx.beginPath();
      ctx.moveTo(x, 0);
      ctx.lineTo(x, h);
      ctx.stroke();
    }
    ctx.restore();

    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    for (const it of state.items){
      const x = (w/laneCount) * it.lane + (w/laneCount)/2;
      ctx.font = `${it.size}px system-ui, Apple Color Emoji, Segoe UI Emoji`;
      ctx.fillText(it.type === "star" ? "‚≠êÔ∏è" : "üçå", x, it.y);
    }

    const laneCenterX = (w/laneCount) * state.lane + (w/laneCount)/2;
    const avatarW = Math.min(160, (w/laneCount) * 0.78);
    const avatarH = avatarW;
    const y = h - avatarH - 20;
    const x = laneCenterX - avatarW/2;

    ctx.save();
    ctx.globalAlpha = 0.08;
    ctx.fillStyle = "#111";
    ctx.fillRect((w/laneCount)*state.lane, 0, (w/laneCount), h);
    ctx.restore();

    ctx.save();
    ctx.fillStyle = "#f6f6f6";
    roundRect(ctx, x, y, avatarW, avatarH, 18, true, false);
    ctx.strokeStyle = "#eaeaea";
    ctx.lineWidth = 2;
    roundRect(ctx, x, y, avatarW, avatarH, 18, false, true);
    ctx.restore();

    if (state.avatarImg){
      ctx.drawImage(state.avatarImg, x, y, avatarW, avatarH);
    }
  }

  function loop(ts){
    if (!state.running) return;
    if (!state.lastTs) state.lastTs = ts;
    const dt = Math.min(0.033, (ts - state.lastTs)/1000);
    state.lastTs = ts;

    update(dt);
    draw();

    if (state.running) requestAnimationFrame(loop);
  }

  async function gameStart(){
    resizeCanvasToViewport();
    resetGame();
    state.avatarImg = await loadAvatar();

    state.running = true;
    state.lastTs = 0;
    requestAnimationFrame(loop);
  }

  function finishGame(){
    state.running = false;
    const digits = PLAYER_DIGITS[currentPlayer] || "00";
    endText.textContent = `Super! Deng 2 Ziffere sinn ${digits}!`;

    endOverlay.style.display = "flex";
    endOverlay.setAttribute("aria-hidden","false");
  }

  toChestBtn.addEventListener("click", () => {
    endOverlay.style.display = "none";
    endOverlay.setAttribute("aria-hidden","true");
    showScreen("chest");
    initChest();
  });

  /* ===================== CHEST LOGIC ===================== */
  const chestImg = document.getElementById("chestImg");
  const chestVid = document.getElementById("chestVid");
  const chestFeedback = document.getElementById("chestFeedback");
  const digitsInputs = [
    document.getElementById("d1"),
    document.getElementById("d2"),
    document.getElementById("d3"),
    document.getElementById("d4")
  ];

  let chestOpened = false;

  function initChest(){
    chestOpened = false;

    // Set sources (URL-encoded filenames)
    chestImg.src = CHEST_PNG;
    chestVid.src = CHEST_MP4;

    chestImg.style.display = "block";
    chestVid.style.display = "none";
    chestVid.pause();
    chestVid.currentTime = 0;

    chestFeedback.textContent = "";
    digitsInputs.forEach(d=>{ d.value=""; d.disabled=false; d.style.borderColor="#e6e6e6"; });
    digitsInputs[0].focus();
  }

  function currentCode(){
    return digitsInputs.map(d => (d.value||"").replace(/\D/g,"")).join("");
  }

  function lockDigits(){ digitsInputs.forEach(d => d.disabled = true); }

  function openChest(){
    if (chestOpened) return;
    chestOpened = true;

    lockDigits();

    chestImg.style.display = "none";
    chestVid.style.display = "block";
    chestVid.currentTime = 0;
    chestVid.play().catch(()=>{});

    setTimeout(() => {
      battleOverlay.style.display = "flex";
      battleOverlay.setAttribute("aria-hidden","false");
    }, 4000);
  }

  digitsInputs.forEach((inp, idx) => {
    inp.addEventListener("input", () => {
      inp.value = (inp.value || "").replace(/\D/g,"").slice(0,1);

      if (inp.value && idx < digitsInputs.length - 1) digitsInputs[idx+1].focus();

      const code = currentCode();
      if (code.length === 4){
        if (code === CHEST_CODE){
          digitsInputs.forEach(d => d.style.borderColor = "#b8f2c2");
          chestFeedback.textContent = "";
          openChest();
        } else {
          digitsInputs.forEach(d => d.style.borderColor = "#ffb3b3");
          chestFeedback.textContent = "‚ùå Code net richteg ‚Äì prob√©ier nach eng K√©ier";
          chestFeedback.style.color = "var(--danger)";
        }
      } else {
        digitsInputs.forEach(d => d.style.borderColor = "#e6e6e6");
        chestFeedback.textContent = "";
      }
    });

    inp.addEventListener("keydown", (e) => {
      if (e.key === "Backspace" && !inp.value && idx > 0){
        digitsInputs[idx-1].focus();
      }
    });
  });

  // Clicking the battle overlay closes it (optional)
  battleOverlay.addEventListener("click", (e) => {
    // keep clicks on the button from closing
    if (e.target.closest("a.btn")) return;
    battleOverlay.style.display = "none";
    battleOverlay.setAttribute("aria-hidden","true");
  });

})();
</script>
</body>
</html>

