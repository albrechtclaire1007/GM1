<!doctype html>
<html lang="lb">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Kart-Challenge</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:rgba(255,255,255,.08);
      --panel2:rgba(0,0,0,.35);
      --text:#eef2ff;
      --muted:rgba(238,242,255,.75);
      --accent:#7ee787;
      --danger:#ff6b6b;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    #wrap{position:fixed;inset:0;display:flex;align-items:stretch;justify-content:center;}
    canvas{display:block; width:100vw; height:100vh; touch-action:none;}
    .hud{
      position:fixed; left:12px; top:12px; right:12px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      pointer-events:none;
    }
    .card{
      pointer-events:none;
      background:var(--panel);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(8px);
      border-radius:16px;
      padding:10px 12px;
      display:flex; align-items:center; gap:10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .avatar{
      width:46px;height:46px;border-radius:999px;
      border:2px solid rgba(255,255,255,.25);
      background:#111;
      object-fit:cover;
    }
    .name{font-weight:700;line-height:1.1}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .score{font-weight:800;font-size:22px}
    .goal{font-size:12px;color:var(--muted)}
    .pill{
      padding:8px 10px;border-radius:999px;background:var(--panel2);
      border:1px solid rgba(255,255,255,.12);
      pointer-events:none;
      display:flex;flex-direction:column;align-items:flex-end;
    }
    .controls{
      position:fixed; left:0; right:0; bottom:14px;
      display:flex; justify-content:center; gap:14px;
      pointer-events:none;
    }
    .btn{
      pointer-events:auto;
      width:72px;height:72px;border-radius:18px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(8px);
      color:var(--text);
      font-size:26px;
      display:flex;align-items:center;justify-content:center;
      user-select:none;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .btn:active{transform:scale(.98)}
    .modal{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.60);
      padding:18px;
    }
    .modal .box{
      width:min(560px, 96vw);
      background:rgba(10,14,26,.92);
      border:1px solid rgba(255,255,255,.14);
      border-radius:22px;
      padding:18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.6);
    }
    .modal h1{margin:0 0 8px 0; font-size:22px}
    .modal p{margin:8px 0; color:var(--muted); line-height:1.35}
    .big{
      margin-top:12px;
      padding:12px 14px;
      border-radius:16px;
      background:rgba(126,231,135,.14);
      border:1px solid rgba(126,231,135,.25);
      font-weight:800;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .action{
      pointer-events:auto;
      border:none;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.16);
      color:var(--text);
      padding:12px 14px;
      border-radius:14px;
      font-weight:700;
      cursor:pointer;
    }
    .action.primary{
      background:rgba(126,231,135,.22);
      border-color:rgba(126,231,135,.35);
    }
    .tiny{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div id="wrap">
    <canvas id="c"></canvas>
  </div>

  <div class="hud">
    <div class="card">
      <img id="avatar" class="avatar" alt="Avatar">
      <div>
        <div class="name" id="playerName">Spiller</div>
        <div class="sub" id="tagline">Prett? Sammel 50 Punkten!</div>
      </div>
    </div>

    <div class="pill">
      <div class="score"><span id="score">0</span> ‚≠ê</div>
      <div class="goal">Zil: 50 ‚≠ê</div>
    </div>
  </div>

  <div class="controls" aria-hidden="false">
    <div class="btn" id="leftBtn">‚üµ</div>
    <div class="btn" id="rightBtn">‚ü∂</div>
  </div>

  <div class="modal" id="winModal">
    <div class="box">
      <h1>üèÅ Bravo! Du hues 50 Punkten!</h1>
      <p id="winText">
        Deng zwou Ziffere fir d‚ÄôSchlass ze knacken: <b>‚Äî ‚Äî</b>
      </p>

      <div class="big">
        üéÅ Kaddo-Reveal: <span id="giftReveal">[Hei k√´nnt d√§i Voucher-Text / Detailer eran]</span>
      </div>

      <p class="tiny">
        Tipp: Wann s du awer l√©iwer eng Schloss-Box w√´lls, so mir just: ech stellen et direkt √´m, datt all Spiller 2 Zifferen kritt.
      </p>

      <div class="row">
        <button class="action primary" id="playAgain">Nach eng K√©ier</button>
        <button class="action" id="closeModal">Zoumaachen</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // ============ AVATAREN (aus √§r Fotoen "gameified") ============
  // Ech hu se fir koh√§rent Look als cartoon-ish Racer Avataren virbereet (PNG base64).
  // Du kanns se och zu all Moment ersetzen.
  const AVATARS = {
    gilles: "%%AVATAR_GILLES%%",
    mara:   "%%AVATAR_MARA%%"
  };

  // ============ PLAYER SETUP ============
  const params = new URLSearchParams(location.search);
  const playerKey = (params.get("player") || "mara").toLowerCase();
  const playerName = playerKey === "gilles" ? "Gilles" : "Mara";

  // Optional: personalis√©ierte Reveal-Text (kanns du hei direkt ausf√´llen)
  // Beispill: "Karting-Voucher: ... Datum ... Plaz ..."
  const GIFT_REVEAL_TEXT = "Karting-Voucher (Mario-Kart-Style) üéüÔ∏è ‚Äî kuck an d‚ÄôEnveloppe / d‚ÄôBox!";

  // ============ GAME TUNING (Lues & easy) ============
  const GOAL_SCORE = 50;

  // "et ass ze s√©ier" -> d√´s W√§erter si bewosst lues + kontroll√©ierbar
  const roadSpeedMin = 140;   // px/sec
  const roadSpeedMax = 240;   // px/sec
  const accel = 260;          // px/sec^2
  const steerSpeed = 520;     // px/sec lateral
  const coinSpawnEvery = 0.55; // seconds (lues genuch)
  const obstacleChance = 0.22; // 0..1

  // ============ CANVAS ============
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");

  function resize() {
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    canvas.width  = Math.floor(innerWidth * dpr);
    canvas.height = Math.floor(innerHeight * dpr);
    canvas.style.width = innerWidth + "px";
    canvas.style.height = innerHeight + "px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener("resize", resize);
  resize();

  // ============ UI ============
  const avatarEl = document.getElementById("avatar");
  const nameEl = document.getElementById("playerName");
  const scoreEl = document.getElementById("score");
  const winModal = document.getElementById("winModal");
  const giftReveal = document.getElementById("giftReveal");
  const winText = document.getElementById("winText");

  nameEl.textContent = playerName;
  avatarEl.src = AVATARS[playerKey] || AVATARS.mara;
  giftReveal.textContent = GIFT_REVEAL_TEXT;

  // (Falls de sp√©ider zr√©ck op Schloss-Box w√´lls: hei g√©ifs de 2 Zifferen setzen)
  winText.innerHTML = `Deng zwou Ziffere fir d‚ÄôSchlass ze knacken: <b>‚Äî ‚Äî</b>`;

  // ============ INPUT ============
  let leftHeld = false, rightHeld = false;
  const leftBtn = document.getElementById("leftBtn");
  const rightBtn = document.getElementById("rightBtn");

  function bindHold(el, onDown, onUp){
    el.addEventListener("pointerdown", (e)=>{ e.preventDefault(); el.setPointerCapture(e.pointerId); onDown(); });
    el.addEventListener("pointerup",   (e)=>{ e.preventDefault(); onUp(); });
    el.addEventListener("pointercancel",(e)=>{ e.preventDefault(); onUp(); });
    el.addEventListener("pointerleave",(e)=>{ /* noop */ });
  }
  bindHold(leftBtn, ()=> leftHeld=true, ()=> leftHeld=false);
  bindHold(rightBtn, ()=> rightHeld=true, ()=> rightHeld=false);

  window.addEventListener("keydown", (e)=>{
    if(e.key==="ArrowLeft") leftHeld=true;
    if(e.key==="ArrowRight") rightHeld=true;
  });
  window.addEventListener("keyup", (e)=>{
    if(e.key==="ArrowLeft") leftHeld=false;
    if(e.key==="ArrowRight") rightHeld=false;
  });

  // Touch/drag anywhere to set a target x (super easy on phone)
  let targetX = null;
  canvas.addEventListener("pointerdown", (e)=>{ targetX = e.clientX; });
  canvas.addEventListener("pointermove", (e)=>{ if(targetX!==null) targetX = e.clientX; });
  canvas.addEventListener("pointerup", ()=>{ targetX = null; });
  canvas.addEventListener("pointercancel", ()=>{ targetX = null; });

  // ============ GAME WORLD ============
  const W = () => innerWidth;
  const H = () => innerHeight;

  const road = {
    x: () => W()/2,
    w: () => Math.min(520, W()*0.74),
    lineOffset: 0
  };

  const kart = {
    x: W()/2,
    y: H()*0.78,
    w: 46,
    h: 70,
    vx: 0
  };

  let score = 0;
  let speed = roadSpeedMin;
  let running = true;

  const coins = [];
  const obstacles = [];
  let spawnT = 0;

  function reset(){
    score = 0;
    scoreEl.textContent = "0";
    speed = roadSpeedMin;
    kart.x = W()/2;
    kart.vx = 0;
    coins.length = 0;
    obstacles.length = 0;
    spawnT = 0;
    running = true;
    winModal.style.display = "none";
    lastTs = null;
    requestAnimationFrame(loop);
  }

  // Helpers
  const clamp = (v,min,max)=> Math.max(min, Math.min(max,v));
  function roadBounds(){
    const rw = road.w();
    return { left: road.x()-rw/2, right: road.x()+rw/2 };
  }

  function spawnCoin(){
    const {left,right} = roadBounds();
    const margin = 40;
    const x = left + margin + Math.random()*(right-left-2*margin);
    coins.push({x, y:-30, r:14, taken:false});
  }
  function spawnObstacle(){
    const {left,right} = roadBounds();
    const margin = 46;
    const x = left + margin + Math.random()*(right-left-2*margin);
    obstacles.push({x, y:-40, w:42, h:42});
  }

  function hitCircleRect(cx,cy,r, rx,ry,rw,rh){
    const nx = clamp(cx, rx, rx+rw);
    const ny = clamp(cy, ry, ry+rh);
    const dx = cx - nx, dy = cy - ny;
    return (dx*dx + dy*dy) <= r*r;
  }

  // ============ DRAW ============
  function drawRoad(dt){
    const rw = road.w();
    const cx = road.x();
    const left = cx - rw/2;
    const top = 0, bottom = H();

    // Asphalt
    ctx.fillStyle = "#1b2238";
    ctx.fillRect(left, top, rw, bottom);

    // Side grass
    ctx.fillStyle = "#0e1528";
    ctx.fillRect(0,0,left, bottom);
    ctx.fillRect(left+rw,0,W(), bottom);

    // Edge lines
    ctx.strokeStyle = "rgba(255,255,255,.25)";
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(left+2,0); ctx.lineTo(left+2,bottom);
    ctx.moveTo(left+rw-2,0); ctx.lineTo(left+rw-2,bottom);
    ctx.stroke();

    // Center dashed line
    road.lineOffset += speed * dt;
    const dashH = 34, gap = 26;
    const x = cx;
    ctx.fillStyle = "rgba(255,255,255,.25)";
    for(let y = -((road.lineOffset)%(dashH+gap)); y < bottom; y += dashH+gap){
      ctx.fillRect(x-4, y, 8, dashH);
    }
  }

  function drawKart(){
    // kart body
    const x = kart.x - kart.w/2;
    const y = kart.y - kart.h/2;

    // shadow
    ctx.fillStyle = "rgba(0,0,0,.35)";
    ctx.beginPath();
    ctx.ellipse(kart.x, kart.y+kart.h*0.32, kart.w*0.62, kart.h*0.18, 0, 0, Math.PI*2);
    ctx.fill();

    // body
    ctx.fillStyle = "#ff4d6d";
    roundRect(x, y+10, kart.w, kart.h-20, 12, true);

    // cockpit
    ctx.fillStyle = "rgba(0,0,0,.28)";
    roundRect(x+8, y+20, kart.w-16, kart.h-40, 10, true);

    // wheels
    ctx.fillStyle = "#0b0f1a";
    roundRect(x-10, y+16, 14, 18, 6, true);
    roundRect(x-10, y+kart.h-34, 14, 18, 6, true);
    roundRect(x+kart.w-4, y+16, 14, 18, 6, true);
    roundRect(x+kart.w-4, y+kart.h-34, 14, 18, 6, true);

    // front highlight
    ctx.fillStyle = "rgba(255,255,255,.18)";
    roundRect(x+10, y+14, kart.w-20, 10, 8, true);

    // small "star" badge
    ctx.fillStyle = "rgba(255,255,255,.85)";
    ctx.beginPath();
    ctx.arc(kart.x, y+18, 5, 0, Math.PI*2);
    ctx.fill();
  }

  function drawCoins(){
    for(const c of coins){
      if(c.taken) continue;
      ctx.save();
      ctx.translate(c.x, c.y);
      // glow
      ctx.fillStyle = "rgba(255,215,0,.18)";
      ctx.beginPath();
      ctx.arc(0,0,c.r*1.9,0,Math.PI*2);
      ctx.fill();
      // coin
      ctx.fillStyle = "#ffd400";
      ctx.beginPath();
      ctx.arc(0,0,c.r,0,Math.PI*2);
      ctx.fill();
      ctx.strokeStyle = "rgba(0,0,0,.25)";
      ctx.lineWidth = 3;
      ctx.stroke();
      // star
      ctx.fillStyle = "rgba(0,0,0,.25)";
      drawStar(0,0,5,7,3);
      ctx.restore();
    }
  }

  function drawObstacles(){
    for(const o of obstacles){
      ctx.save();
      ctx.translate(o.x, o.y);
      // banana-ish hazard (original, not copied)
      ctx.fillStyle = "#ffcf5a";
      roundRect(-o.w/2, -o.h/2, o.w, o.h, 12, true);
      ctx.fillStyle = "rgba(0,0,0,.18)";
      ctx.beginPath();
      ctx.arc(0, 4, 10, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
    }
  }

  function drawStar(cx,cy,spikes,outerR,innerR){
    let rot = Math.PI/2 * 3;
    let x = cx, y = cy;
    const step = Math.PI / spikes;
    ctx.beginPath();
    ctx.moveTo(cx, cy - outerR);
    for(let i=0;i<spikes;i++){
      x = cx + Math.cos(rot) * outerR;
      y = cy + Math.sin(rot) * outerR;
      ctx.lineTo(x,y);
      rot += step;
      x = cx + Math.cos(rot) * innerR;
      y = cy + Math.sin(rot) * innerR;
      ctx.lineTo(x,y);
      rot += step;
    }
    ctx.lineTo(cx, cy - outerR);
    ctx.closePath();
    ctx.fill();
  }

  function roundRect(x,y,w,h,r,fill){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
    if(fill) ctx.fill();
  }

  // ============ LOOP ============
  let lastTs = null;

  function loop(ts){
    if(!running) return;
    if(lastTs===null) lastTs = ts;
    const dt = Math.min(0.033, (ts - lastTs)/1000);
    lastTs = ts;

    // speed ramps gently
    speed = clamp(speed + accel*dt, roadSpeedMin, roadSpeedMax);

    // steering
    let dir = 0;
    if(leftHeld) dir -= 1;
    if(rightHeld) dir += 1;

    if(targetX !== null){
      // move toward finger, smoothly
      const dx = targetX - kart.x;
      kart.vx = clamp(dx*6, -steerSpeed, steerSpeed);
    } else {
      kart.vx = dir * steerSpeed;
    }

    kart.x += kart.vx * dt;

    // keep inside road
    const {left,right} = roadBounds();
    const pad = kart.w*0.52;
    kart.x = clamp(kart.x, left+pad, right-pad);

    // spawns
    spawnT += dt;
    if(spawnT >= coinSpawnEvery){
      spawnT = 0;
      spawnCoin();
      if(Math.random() < obstacleChance) spawnObstacle();
    }

    // move objects
    for(const c of coins) c.y += speed*dt;
    for(const o of obstacles) o.y += speed*dt;

    // collisions
    const kx = kart.x - kart.w/2;
    const ky = kart.y - kart.h/2;
    for(const c of coins){
      if(c.taken) continue;
      if(hitCircleRect(c.x, c.y, c.r, kx, ky, kart.w, kart.h)){
        c.taken = true;
        score += 1;
        scoreEl.textContent = String(score);
        if(score >= GOAL_SCORE){
          win();
          return;
        }
      }
    }
    for(const o of obstacles){
      // if hit -> slow a bit (but no game over)
      const rx = o.x - o.w/2, ry = o.y - o.h/2;
      if(hitCircleRect(kart.x, kart.y, 18, rx, ry, o.w, o.h)){
        speed = Math.max(roadSpeedMin, speed - 140);
      }
    }

    // cleanup
    while(coins.length && coins[0].y > H()+60) coins.shift();
    while(obstacles.length && obstacles[0].y > H()+80) obstacles.shift();

    // draw
    ctx.clearRect(0,0,W(),H());
    drawRoad(dt);
    drawCoins();
    drawObstacles();
    drawKart();

    requestAnimationFrame(loop);
  }

  function win(){
    running = false;
    // keep Lux text user requested:
    winText.innerHTML = `Deng zwou Ziffere fir d‚ÄôSchlass ze knacken: <b>‚Äî ‚Äî</b>`;
    // digital reveal:
    winModal.style.display = "flex";
  }

  document.getElementById("playAgain").addEventListener("click", reset);
  document.getElementById("closeModal").addEventListener("click", ()=>{ winModal.style.display="none"; });

  // start
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>

