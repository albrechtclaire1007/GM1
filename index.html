<!doctype html>
<html lang="lb">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Kart-Challenge</title>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#0b0f14; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap { height:100%; display:flex; flex-direction:column; }
    header { padding:14px 14px 8px; color:#e9eef5; }
    header .top { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
    .title { font-size:20px; font-weight:800; letter-spacing:.2px; }
    .sub { font-size:13px; opacity:.85; margin-top:4px; line-height:1.25; }
    .pill { background:#151b23; border:1px solid #263041; border-radius:999px; padding:8px 10px; font-size:13px; min-width:110px; text-align:right; }
    canvas { width:100%; flex:1; display:block; background:linear-gradient(#101826, #070a0f); touch-action:none; }
    .controls {
      display:flex; gap:10px; padding:12px 14px 18px; background:#0b0f14;
      border-top:1px solid #1f2836;
    }
    button {
      flex:1; padding:14px 12px; border-radius:14px; border:1px solid #2b3850;
      background:#121a26; color:#e9eef5; font-size:16px; font-weight:800;
      -webkit-tap-highlight-color: transparent;
    }
    button:active { transform: translateY(1px); }
    .overlay {
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.62); padding:18px;
    }
    .card {
      width:min(520px, 100%); background:#0f1622; border:1px solid #2b3850; border-radius:18px;
      padding:16px 16px 14px; color:#e9eef5;
      box-shadow: 0 14px 50px rgba(0,0,0,.45);
    }
    .card h2 { margin:0 0 6px; font-size:20px; }
    .card p { margin:8px 0; opacity:.9; line-height:1.3; }
    .row { display:flex; gap:10px; margin-top:12px; }
    .row button { background:#162136; }
    .small { font-size:12px; opacity:.75; }
    .revealBox {
      margin-top:10px; padding:12px; border-radius:14px;
      background:#101c2d; border:1px dashed #355079;
    }
    .revealBox .big { font-size:18px; font-weight:900; margin-top:6px; }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="top">
      <div>
        <div class="title">Kart-Challenge</div>
        <div class="sub">Sammel ‚≠ê St√§ren a vermeid üí• Hindernisser. <b>Zil: 50 Punkten</b>.</div>
      </div>
      <div class="pill">
        Punkten: <b id="score">0</b><br/>
        <span class="small">Best: <span id="best">0</span></span>
      </div>
    </div>
  </header>

  <canvas id="game" width="720" height="1280"></canvas>

  <div class="controls">
    <button id="left" aria-label="L√©nks">‚¨ÖÔ∏è L√©nks</button>
    <button id="right" aria-label="Riets">Riets ‚û°Ô∏è</button>
  </div>
</div>

<!-- Start / Win / Game over overlay -->
<div class="overlay" id="overlay">
  <div class="card">
    <h2 id="ovTitle">Prett?</h2>
    <p id="ovText">
      Tippen op <b>Start</b>. Fuert de Kart, sammelt ‚≠ê a kommt op <b>50</b>.
    </p>

    <div class="revealBox" id="revealBox" style="display:none;">
      <div><b>üéÅ Surprise!</b> Du hues 50 Punkten erreecht.</div>
      <div class="big" id="revealText">Hei ass d√§i Kaddo: <span id="voucherText">[DEIN VOUCHER TEXT]</span></div>
      <div class="small" style="margin-top:8px;">
        (Wann s de l√©iwer eng Box mat Code w√´lls: ‚ÄúDeng zwou Ziffere fir d‚ÄôSchlass ze knacken‚Äù kann ech och aktiv√©ieren.)
      </div>
    </div>

    <div class="row">
      <button id="startBtn">Start</button>
      <button id="restartBtn" style="display:none;">Nach eng K√©ier</button>
    </div>
    <p class="small" style="margin-top:10px;">
      Tipp: Um Handy geet et am beschten mat de Kn√§ppercher √´nnen (oder mat Pfeiltasten um PC).
    </p>
  </div>
</div>

<script>
(() => {
  // ---------- Settings you can change ----------
  const TARGET_SCORE = 50;

  // Put your real voucher reveal text here:
  const VOUCHER_REVEAL = "Karting-Voucher üéüÔ∏è (Datum/Plaz steet op der Kaart)";

  // Difficulty tweaks:
  const SPEED_START = 7.0;
  const SPEED_MAX   = 15.0;
  const SPAWN_STAR_EVERY_MS = 550;   // more frequent = easier
  const SPAWN_OBS_EVERY_MS  = 850;   // less frequent = easier
  const OBS_PENALTY = 3;             // points lost on hit
  const STAR_VALUE  = 1;

  // ---------- Canvas / game state ----------
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');

  const scoreEl = document.getElementById('score');
  const bestEl  = document.getElementById('best');

  const overlay = document.getElementById('overlay');
  const ovTitle = document.getElementById('ovTitle');
  const ovText  = document.getElementById('ovText');
  const revealBox  = document.getElementById('revealBox');
  const voucherText = document.getElementById('voucherText');
  voucherText.textContent = VOUCHER_REVEAL;

  const startBtn   = document.getElementById('startBtn');
  const restartBtn = document.getElementById('restartBtn');

  const leftBtn  = document.getElementById('left');
  const rightBtn = document.getElementById('right');

  // Fit canvas to device ratio (keep internal resolution stable-ish)
  function resizeCanvas() {
    const cssW = canvas.clientWidth;
    const cssH = canvas.clientHeight;
    const dpr = Math.min(2, window.devicePixelRatio || 1);
    canvas.width  = Math.floor(cssW * dpr);
    canvas.height = Math.floor(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  const laneCount = 3;
  let lanes = []; // x centers, computed from canvas size

  function computeLanes() {
    const w = canvas.clientWidth;
    const roadW = Math.min(420, w * 0.78);
    const roadX = (w - roadW) / 2;
    const laneW = roadW / laneCount;
    lanes = Array.from({length: laneCount}, (_, i) => roadX + laneW*(i + 0.5));
    return { roadX, roadW, laneW };
  }

  let running = false;
  let score = 0;
  let best = Number(localStorage.getItem('kart_best') || 0);
  bestEl.textContent = best;

  const player = {
    lane: 1,
    x: 0,
    y: 0,
    w: 44,
    h: 64
  };

  const stars = [];
  const obstacles = [];

  let speed = SPEED_START;
  let lastT = 0;
  let starTimer = 0;
  let obsTimer = 0;

  function resetGame() {
    score = 0;
    scoreEl.textContent = score;
    stars.length = 0;
    obstacles.length = 0;
    player.lane = 1;
    speed = SPEED_START;
    lastT = performance.now();
    starTimer = 0;
    obsTimer = 0;
    revealBox.style.display = "none";
    restartBtn.style.display = "none";
    startBtn.style.display = "inline-block";
    ovTitle.textContent = "Prett?";
    ovText.innerHTML = "Tippen op <b>Start</b>. Fuert de Kart, sammelt ‚≠ê a kommt op <b>50</b>.";
  }

  function showOverlay(type) {
    overlay.style.display = "flex";
    if (type === "start") {
      ovTitle.textContent = "Prett?";
      ovText.innerHTML = "Tippen op <b>Start</b>. Fuert de Kart, sammelt ‚≠ê a kommt op <b>50</b>.";
      startBtn.style.display = "inline-block";
      restartBtn.style.display = "none";
      revealBox.style.display = "none";
    } else if (type === "over") {
      ovTitle.textContent = "Oups üòÖ";
      ovText.innerHTML = "Du bass un en Hindernis komm. Prob√©ier nach eng K√©ier!";
      startBtn.style.display = "none";
      restartBtn.style.display = "inline-block";
      revealBox.style.display = "none";
    } else if (type === "win") {
      ovTitle.textContent = "Bravo! üèÅ";
      ovText.innerHTML = "Du hues <b>50</b> Punkten erreecht!";
      startBtn.style.display = "none";
      restartBtn.style.display = "inline-block";
      revealBox.style.display = "block";
    }
  }

  function hideOverlay() {
    overlay.style.display = "none";
  }

  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

  function moveLane(dir) {
    player.lane = clamp(player.lane + dir, 0, laneCount - 1);
  }

  function spawnStar(road) {
    const lane = Math.floor(Math.random()*laneCount);
    stars.push({
      lane,
      x: lanes[lane],
      y: -40,
      r: 16
    });
  }

  function spawnObstacle(road) {
    const lane = Math.floor(Math.random()*laneCount);
    obstacles.push({
      lane,
      x: lanes[lane],
      y: -60,
      w: 46,
      h: 46
    });
  }

  function rectsOverlap(ax, ay, aw, ah, bx, by, bw, bh) {
    return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
  }

  function update(dtMs) {
    const dt = dtMs / 16.67;

    const road = computeLanes();
    const w = canvas.clientWidth;
    const h = canvas.clientHeight;

    player.x = lanes[player.lane] - player.w/2;
    player.y = h * 0.78;

    // ramp speed slowly
    speed = Math.min(SPEED_MAX, speed + 0.005 * dt);

    // spawn timers
    starTimer += dtMs;
    obsTimer += dtMs;

    if (starTimer >= SPAWN_STAR_EVERY_MS) {
      starTimer = 0;
      spawnStar(road);
    }
    if (obsTimer >= SPAWN_OBS_EVERY_MS) {
      obsTimer = 0;
      spawnObstacle(road);
    }

    // move items
    const dy = speed * 8 * dt;

    for (const s of stars) s.y += dy;
    for (const o of obstacles) o.y += dy;

    // collisions with stars
    for (let i = stars.length - 1; i >= 0; i--) {
      const s = stars[i];
      const sx = s.x - s.r;
      const sy = s.y - s.r;
      const sw = s.r * 2;
      const sh = s.r * 2;
      if (rectsOverlap(player.x, player.y, player.w, player.h, sx, sy, sw, sh)) {
        stars.splice(i, 1);
        score += STAR_VALUE;
        scoreEl.textContent = score;

        if (score > best) {
          best = score;
          bestEl.textContent = best;
          localStorage.setItem('kart_best', String(best));
        }

        if (score >= TARGET_SCORE) {
          running = false;
          showOverlay("win");
        }
      } else if (s.y > h + 60) {
        stars.splice(i, 1);
      }
    }

    // collisions with obstacles
    for (let i = obstacles.length - 1; i >= 0; i--) {
      const o = obstacles[i];
      if (rectsOverlap(player.x, player.y, player.w, player.h, o.x - o.w/2, o.y - o.h/2, o.w, o.h)) {
        // penalty + small "shake" feel
        obstacles.splice(i, 1);
        score = Math.max(0, score - OBS_PENALTY);
        scoreEl.textContent = score;
      } else if (o.y > h + 80) {
        obstacles.splice(i, 1);
      }
    }
  }

  function draw() {
    const road = computeLanes();
    const w = canvas.clientWidth;
    const h = canvas.clientHeight;

    // background
    ctx.clearRect(0,0,w,h);

    // road
    ctx.fillStyle = "#0b1320";
    ctx.fillRect(road.roadX, 0, road.roadW, h);

    // lane lines
    ctx.strokeStyle = "rgba(255,255,255,0.12)";
    ctx.lineWidth = 3;
    for (let i = 1; i < laneCount; i++) {
      const x = road.roadX + (road.roadW/laneCount)*i;
      ctx.setLineDash([18, 18]);
      ctx.beginPath();
      ctx.moveTo(x, 0);
      ctx.lineTo(x, h);
      ctx.stroke();
    }
    ctx.setLineDash([]);

    // stars (coins)
    for (const s of stars) {
      ctx.beginPath();
      ctx.fillStyle = "#ffd24a";
      ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
      ctx.fill();

      ctx.fillStyle = "rgba(0,0,0,0.18)";
      ctx.beginPath();
      ctx.arc(s.x-4, s.y+4, s.r*0.45, 0, Math.PI*2);
      ctx.fill();

      ctx.fillStyle = "#0b0f14";
      ctx.font = "bold 18px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("‚òÖ", s.x, s.y+1);
    }

    // obstacles
    for (const o of obstacles) {
      ctx.save();
      ctx.translate(o.x, o.y);
      ctx.fillStyle = "#ff5a5a";
      ctx.beginPath();
      ctx.roundRect(-o.w/2, -o.h/2, o.w, o.h, 10);
      ctx.fill();

      ctx.fillStyle = "rgba(0,0,0,0.25)";
      ctx.beginPath();
      ctx.roundRect(-o.w/2+6, -o.h/2+6, o.w-12, o.h-12, 8);
      ctx.fill();

      ctx.fillStyle = "#0b0f14";
      ctx.font = "900 18px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("üí•", 0, 1);
      ctx.restore();
    }

    // player kart
    ctx.save();
    ctx.translate(player.x, player.y);
    ctx.fillStyle = "#59c1ff";
    ctx.beginPath();
    ctx.roundRect(0, 0, player.w, player.h, 12);
    ctx.fill();

    // "helmet" window
    ctx.fillStyle = "rgba(0,0,0,0.25)";
    ctx.beginPath();
    ctx.roundRect(6, 10, player.w-12, 22, 10);
    ctx.fill();

    // wheels
    ctx.fillStyle = "#0b0f14";
    ctx.beginPath(); ctx.roundRect(-8, 10, 10, 18, 6); ctx.fill();
    ctx.beginPath(); ctx.roundRect(player.w-2, 10, 10, 18, 6); ctx.fill();
    ctx.beginPath(); ctx.roundRect(-8, player.h-28, 10, 18, 6); ctx.fill();
    ctx.beginPath(); ctx.roundRect(player.w-2, player.h-28, 10, 18, 6); ctx.fill();

    // driver icon placeholder (can be replaced with your stylised portrait later)
    ctx.fillStyle = "rgba(255,255,255,0.9)";
    ctx.beginPath();
    ctx.arc(player.w/2, player.h-14, 10, 0, Math.PI*2);
    ctx.fill();

    ctx.restore();

    // HUD: target hint
    ctx.fillStyle = "rgba(255,255,255,0.85)";
    ctx.font = "700 14px system-ui";
    ctx.textAlign = "left";
    ctx.fillText("Zil: 50 Punkten", 14, h - 14);
  }

  function loop(t) {
    if (!running) return;
    const dt = t - lastT;
    lastT = t;

    update(dt);
    draw();
    requestAnimationFrame(loop);
  }

  function startGame() {
    hideOverlay();
    running = true;
    lastT = performance.now();
    requestAnimationFrame(loop);
  }

  // ---------- Input ----------
  leftBtn.addEventListener('click', () => moveLane(-1));
  rightBtn.addEventListener('click', () => moveLane(+1));

  // swipe left/right on canvas
  let touchX = null;
  canvas.addEventListener('touchstart', (e) => {
    if (!e.touches || !e.touches[0]) return;
    touchX = e.touches[0].clientX;
  }, {passive:true});
  canvas.addEventListener('touchend', (e) => {
    if (touchX === null) return;
    const endX = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0].clientX : touchX;
    const dx = endX - touchX;
    if (Math.abs(dx) > 22) moveLane(dx > 0 ? +1 : -1);
    touchX = null;
  }, {passive:true});

  // keyboard
  window.addEventListener('keydown', (e) => {
    if (e.key === "ArrowLeft") moveLane(-1);
    if (e.key === "ArrowRight") moveLane(+1);
  });

  startBtn.addEventListener('click', () => { resetGame(); startGame(); });
  restartBtn.addEventListener('click', () => { resetGame(); startGame(); });

  // show start overlay initially
  resetGame();
  showOverlay("start");

})();
</script>
</body>
</html>
